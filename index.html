<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
	<head>
		<title>Airboy's Spreadsheet Conversion</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="http://code.jquery.com/jquery-3.3.1.slim.js"></script>
		<script src="js/jquery.csv.js"></script>
		<script src="js/helpers.js"></script>
		<script src="js/plotly-latest.min.js"></script>
	</head>
	<body>
		<script>
			$(document).ready(function() {
			  if(isFileAPIAvailable()) {
				$('#files').bind('change', handleDialog);
			  }
			});
			
			var data;
			var data2;

			function convertArrayFormat(data) {
				var out=[];
				for (row=1;row<data.length;row++){
				  for (col=0;col<data[0].length;col++){
					if (typeof out[col] === "undefined") out[col]=[];
					out[col].push(data[row][col]);
				  }
				}
				return out;
			}

			function populateColumnNames(data) {
				//foreach data
				//output a checkbox for the data[0]
				$("#colnames").html("");
				$("#colnames").append("<span>X Y</span></br>");
				for (i = 0; i < data[0].length; i++) {
					$("#colnames").append(
					"<span><input type='radio' id='colx_"+i+"' name='X' value='"+i+"'>"+
					"<input type='checkbox' id='coly1_"+i+"' name='Y1' value='"+i+"'>"+
					"<input type='checkbox' id='coly2_"+i+"' name='Y2' value='"+i+"'>"+
					data[0][i]+
					"</span><br/>");
				}
				
				$('#colnames input:checkbox').change(function () {
					updateGraph();
				});
			}
			
			function updateGraph() {
				//get all selected Y items
				//add them to the graph (limited to y2 right now)
				var selected = $('#colnames input:checkbox:checked');
				var plot_left = [];
				var plot_right = [];
				for (i = 0; i < selected.length; i++) {
					if ($(selected[i]).prop("name") === "Y1") {
						plot_left.push(data2[$(selected[i]).val()]);
					}
					else {
						plot_right.push(data2[$(selected[i]).val()]);
					}
				}
				renderGraph2(data2[0], plot_left, plot_right);
			}
			
			function renderGraph2(x, y_left, y_right) {
				if (typeof y_left === "undefined") {
					y_left = [];
				}
				if (typeof y_right === "undefined") {
					y_right = [];
				}
				TESTER = document.getElementById('tester');
				var traces = [];
				for (i = 0; i < y_left.length; i++) {
					traces.push({
					name: 'a',
					legendgroup: 'group',
					x: x, 
					y: y_left[i], 
					type: 'line'});
				}
				for (i = 0; i < y_right.length; i++) {
					traces.push({
					name: 'a',
					legendgroup: 'group2',
					x: x, 
					y: y_right[i], 
					yaxis: "y2",
					type: 'line'});
				}
				var layout = {
					yaxis: {
						title: 'the left'
					},
					yaxis2: {
						title: 'the right',
						overlaying: 'y',
						side: 'right'
					},
					legend: {
						x: 1.1,
						y: 0.5
					}
				};
				Plotly.newPlot(TESTER, traces, layout);
			}
			
			function renderGraph(x, y, y2) {
				TESTER = document.getElementById('tester');
				var trace1 = {
					x: x,
					y: y,
					type: 'line'
				};
				var data = [trace1];
				
				if (typeof y2 !== "undefined") {
					var trace2 = {
						x: x,
						y: y2,
						type: 'line'
					};
					data.push(trace2);
				}
				Plotly.newPlot( TESTER, data, {
				margin: { t: 0 } } );
			}
			
			
			function handleDialog(event) {
			  var files = event.target.files;
			  var file = files[0];

			  var fileInfo = `
				<span style="font-weight:bold;">${escape(file.name)}</span><br>
				- FileType: ${file.type || 'n/a'}<br>
				- FileSize: ${file.size} bytes<br>
				- LastModified: ${file.lastModifiedDate ? file.lastModifiedDate.toLocaleDateString() : 'n/a'}
			  `;
			  $('#file-info').append(fileInfo);

			  var reader = new FileReader();
			  reader.readAsText(file);
			  reader.onload = function(event){
				var csv = event.target.result;
				data = $.csv.toArrays(csv);
				data2 = convertArrayFormat(data);
				populateColumnNames(data);
				renderGraph(data2[0], data2[1], data2[2]);
				
				$('#result').empty();
				$('#result').html(JSON.stringify(data, null, 2));
				
			  }
			}
		</script>
		<div id="container">
			<section id="content">
			  <h2>Description</h2>
			  <p>Select your log file.</p>
			  <hr>
			  <h2>Input</h2>
			  <input type="file" id="files" name="files[]" multiple />
			  <hr />
			  <h2>FileInfo</h2>
			  <div id="file-info"></div>
			  <hr />
			  <h2>Result</h2>
			  <textarea id="result" style="height: 250px;"></textarea>
			  <div id="colnames"></div>
			</section>
		</div>
		<hr/>
		<div id="tester_wrapper" style="width:800px;height:400px;">
			<div id="tester"></div>
		</div>
		
		<script>
		$(document).ready(function() {
			TESTER = document.getElementById('tester');
			Plotly.newPlot( TESTER, [{
			x: [1, 2, 3, 4, 5],
			y: [1, 2, 4, 8, 16] }], {
			margin: { t: 0 } } );
			});
		</script>
	</body>
</html>
